{% extends CMSOJ/Views/admin/main.html %}

{% block title %} Menu Items {% endblock %}

{% block page %}
<header class="content-header">
  <div>
    <h2>Menu Items</h2>
    <p>Quickly manage multilingual items, prices and visibility.</p>
  </div>

  <div class="actions">
    <?php $returnTo = $_SERVER['REQUEST_URI'] ?? '' ;
    echo '<a href="/admin/menu/items/create/?return_to=' . $returnTo . '" class="btn btn-primary">+ New Item</a>';
    ?>
  </div>
</header>

<form method="get" class="filter-bar">
  <label>
    Section
    <select name="section_id">
      {% foreach ($sectionsFilter as $val => $label): %}
        <option value="<?= htmlspecialchars($val) ?>"
          <?= (isset($query['section_id']) && (string)$query['section_id'] === (string)$val) ? 'selected' : '' ?>>
          <?= htmlspecialchars($label) ?>
        </option>
      {% endforeach; %}
    </select>
  </label>

  <label>
    Status
    <select name="status">
      <option value="all" <?= ($query['status'] ?? 'all') === 'all' ? 'selected' : '' ?>>All</option>
      <option value="1"   <?= ($query['status'] ?? 'all') === '1'   ? 'selected' : '' ?>>Active</option>
      <option value="0"   <?= ($query['status'] ?? 'all') === '0'   ? 'selected' : '' ?>>Inactive</option>
    </select>
  </label>

  <label>
    Search
    <input type="text" name="search" value="<?= htmlspecialchars($query['search'] ?? '', ENT_QUOTES, 'UTF-8') ?>" placeholder="Search name or description">
  </label>

  <button type="submit" class="btn">Filter</button>
</form>

{% component 'admin/table', [
  'headers'  => $headers,
  'rows'     => $rows,
  'sortable' => $sortable,
  'query'    => $query,
  'bulk'     => $bulk
] %}

<script>
  async function menuItemUpdateInline(id, field, value) {
    const res = await fetch('/admin/menu/items/update-inline', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ id, field, value })
    });

    try {
      const data = await res.json();
      return !!data.success;
    } catch (e) {
      return false;
    }
  }

  document.addEventListener('change', async (e) => {
    const target = e.target;
    if (!target.matches('.inline-edit, .toggle-active')) return;

    const tr = target.closest('tr');
    if (!tr) return;

    const id    = tr.dataset.id;
    const field = target.dataset.inline;
    let value;

    if (!field) return;

    if (target.type === 'checkbox') {
      value = target.checked ? 1 : 0;
    } else {
      value = target.value;
    }

    const ok = await menuItemUpdateInline(id, field, value);

    if (ok && !target.type === 'checkbox') {
      target.style.background = '#d1ffd1';
      setTimeout(() => target.style.background = '', 800);
    }
  });
</script>
{% endblock %}
